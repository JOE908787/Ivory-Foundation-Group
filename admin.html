<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin - Ivory Foundation Group</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <div class="logo">Ivory Foundation Group - Admin</div>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="contact.html">Contact</a></li>
        <li><a href="clients.html">Clients</a></li>
      </ul>
    </div>
  </nav>
  <section class="page-header">
    <div class="container">
      <h1>Admin Uploads</h1>
      <p>This page is for administrators to upload protected specification sheets.</p>
    </div>
  </section>
  <section class="content-section">
    <div class="container">
      <div id="admin-area">
        <p>Checking authentication...</p>
      </div>
    </div>
  </section>
  <script>
    async function init(){
      const res = await fetch('/api/me');
      if (!res.ok) return location.href = '/clients.html';
      const me = await res.json();
      // Admin UI: show users and files lists
      const adminArea = document.getElementById('admin-area');
      adminArea.innerHTML = `
        <p>Signed in as ${me.email}</p>
        <div style="display:flex;gap:2rem;flex-wrap:wrap">
          <div style="flex:1;min-width:300px">
            <h3>Upload File</h3>
            <form id="upload-form" enctype="multipart/form-data">
              <input type="file" name="file" required>
              <button type="submit" class="cta-button">Upload File</button>
            </form>
            <div id="upload-msg" style="margin-top:1rem;color:#b22222"></div>
          </div>
          <div style="flex:1;min-width:300px">
            <h3>Files</h3>
            <div id="files-list-admin">Loading files...</div>
          </div>
          <div style="flex:1;min-width:300px">
            <h3>Users</h3>
            <div id="users-list">Loading users...</div>
          </div>
        </div>
        <div style="margin-top:2rem">
          <h3>Audit Logs</h3>
          <div id="audit-logs-list">Loading audit logs...</div>
        </div>
      `;

      document.getElementById('upload-form').addEventListener('submit', async function(e){
        e.preventDefault();
        const f = this.querySelector('input[type=file]').files[0];
        if (!f) return;
        const fd = new FormData(); fd.append('file', f);
        const r = await fetch('/api/upload',{method:'POST',body:fd});
        const j = await r.json();
        const msg = document.getElementById('upload-msg');
        if (j && j.ok) msg.style.color = '#1a472a', msg.textContent = 'Upload successful'; else msg.textContent = j.error || 'Upload failed';
        if (j && j.ok) { loadFiles(); loadAuditLogs(); }
      });

      async function loadFiles(){
        const el = document.getElementById('files-list-admin');
        el.textContent = 'Loading...';
        const r = await fetch('/api/files');
        if (!r.ok) { el.textContent = 'Failed to load'; return; }
        const files = await r.json();
        if (!files || files.length===0) { el.innerHTML = '<p>No files.</p>'; return; }
        const ul = document.createElement('ul');
        files.forEach(f=>{
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = '/protected-files/' + f.id;
          a.textContent = f.originalname + ' (' + new Date(f.uploaded_at).toLocaleString() + ')';
          const btn = document.createElement('button'); btn.textContent = 'Delete'; btn.style.marginLeft='0.5rem'; btn.addEventListener('click', async ()=>{
            if (!confirm('Delete file?')) return; const d = await fetch('/api/files/'+f.id,{method:'DELETE'}); if (d.ok) { loadFiles(); loadAuditLogs(); } else alert('Delete failed');
          });
          li.appendChild(a); li.appendChild(btn); ul.appendChild(li);
        });
        el.innerHTML = ''; el.appendChild(ul);
      }

      async function loadUsers(){
        const el = document.getElementById('users-list');
        el.textContent = 'Loading...';
        const r = await fetch('/api/users');
        if (!r.ok) { el.textContent = 'Failed to load'; return; }
        const users = await r.json();
        if (!users || users.length===0) { el.innerHTML = '<p>No users.</p>'; return; }
        const ul = document.createElement('ul');
        users.forEach(u=>{
          const li = document.createElement('li');
          li.textContent = `${u.email} (${u.name || ''}) ${u.is_admin? '[admin]':''}`;
          
          // Toggle admin button
          const toggleBtn = document.createElement('button');
          toggleBtn.textContent = u.is_admin ? 'Demote' : 'Promote';
          toggleBtn.style.marginLeft='0.5rem';
          toggleBtn.addEventListener('click', async ()=>{
            if (!confirm(`${u.is_admin ? 'Demote' : 'Promote'} user?`)) return;
            const p = await fetch('/api/users/'+u.id,{method:'PATCH'});
            if (p.ok) { loadUsers(); loadAuditLogs(); } else { alert('Toggle failed'); }
          });
          if (u.id === me.id) { toggleBtn.disabled = true; toggleBtn.title = 'Cannot change your own role'; }
          li.appendChild(toggleBtn);
          
          // Delete button
          const del = document.createElement('button'); del.textContent = 'Delete'; del.style.marginLeft='0.5rem';
          del.addEventListener('click', async ()=>{
            if (!confirm('Delete user?')) return; const d = await fetch('/api/users/'+u.id,{method:'DELETE'}); if (d.ok) { loadUsers(); loadAuditLogs(); } else { alert('Delete failed'); }
          });
          if (u.id === me.id) { del.disabled = true; del.title = 'Cannot delete yourself'; }
          li.appendChild(del);
          ul.appendChild(li);
        });
        el.innerHTML = ''; el.appendChild(ul);
      }

      async function loadAuditLogs(){
        const el = document.getElementById('audit-logs-list');
        el.textContent = 'Loading...';
        const r = await fetch('/api/audit-logs');
        if (!r.ok) { el.textContent = 'Failed to load audit logs'; return; }
        const logs = await r.json();
        if (!logs || logs.length===0) { el.innerHTML = '<p>No audit logs.</p>'; return; }
        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.style.fontSize = '0.9em';
        
        const header = table.createTHead();
        const headerRow = header.insertRow();
        ['Timestamp', 'Action', 'User ID', 'Resource', 'Details'].forEach(h => {
          const th = document.createElement('th');
          th.textContent = h;
          th.style.padding = '8px';
          th.style.border = '1px solid #ddd';
          th.style.textAlign = 'left';
          th.style.backgroundColor = '#f5f5f5';
          headerRow.appendChild(th);
        });
        
        const tbody = table.createTBody();
        logs.forEach(log => {
          const row = tbody.insertRow();
          const cells = [
            new Date(log.timestamp).toLocaleString(),
            log.action,
            log.user_id,
            `${log.resource_type} #${log.resource_id}`,
            log.details
          ];
          cells.forEach(cell => {
            const td = row.insertCell();
            td.textContent = cell;
            td.style.padding = '8px';
            td.style.border = '1px solid #ddd';
          });
        });
        el.innerHTML = ''; el.appendChild(table);
      }

      loadFiles(); loadUsers(); loadAuditLogs();
    }
    init().catch(()=>location.href='/clients.html');
  </script>
</body>
</html>
